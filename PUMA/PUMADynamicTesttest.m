clear; close all; clc
%%

puma = mdl_puma560();

g = 9.81;

% Unpack the Robot Object
L = puma.links;

m1 = L(1).m;
m2 = L(2).m;
m3 = L(3).m;

a2 = 0.4318;
d3 = 0.1254;
    
a3 = 0.0191;
d4 = 0.4318;

L_length = L(2).a 

L1 = L_length;
L2 = L_length;


I_C1 = L(1).I;
I_C2 = L(2).I;
I_C3 = L(3).I;

% Verify Answer
I_xx_c1 = I_C1(1, 1);
I_yy_c1 = I_C1(2, 2);
I_zz_c1 = I_C1(3, 3);

I_xx_c2 = I_C2(1, 1);
I_yy_c2 = I_C2(2, 2);
I_zz_c2 = I_C2(3, 3);

I_xx_c3 = I_C3(1, 1);
I_yy_c3 = I_C3(2, 2);
I_zz_c3 = I_C3(3, 3);

r1 = L(1).r
r2 = L(2).r
r3 = L(3).r

px_c1 = r1(1)
py_c1 = r1(2)
pz_c1 = r1(3)

px_c2 = r2(1)
py_c2 = r2(2)
pz_c2 = r2(3)

px_c3 = r3(1)
py_c3 = r3(2)
pz_c3 = r3(3)

% Transformation from the wrist to the tool 
    Px_6_tool = -0.10000;
    Pz_6_tool =  0.13625;

%%
q2 = -pi/4;
q2dot = 0.1;
q2dotdot = 0.01;

q1dot = 0.1;
q1dotdot = 0.01;

q3 = -pi/4;
q3dot = 0.1;
q3dotdot = 0.01;

q4 = -pi/4;
q4dot = 0.1;
q4dotdot = 0.01;

fx = 0
ft1 = fx
fy = 0
ft2 = fy
fz = 0
ft3 = fz

nx = 0
ft4 = nx
ny = 0
ft5 = ny
nz = 0
ft6 = nz

%% Testing (EOM Answer)

% Answer from PUMADynamicTest
TAU_A = [(I_xx_c2*q1dotdot)/2 + (I_xx_c3*q1dotdot)/2 + (I_yy_c2*q1dotdot)/2 + (I_yy_c3*q1dotdot)/2 + I_zz_c1*q1dotdot + (ny*cos(q2 + q3 - q4))/2 - (nx*sin(q2 + q3 - q4))/2 - nz*cos(q2 + q3) - (ny*cos(q2 + q3 + q4))/2 - (nx*sin(q2 + q3 + q4))/2 + d3^2*m3*q1dotdot + m1*px_c1^2*q1dotdot + (m2*px_c2^2*q1dotdot)/2 + (m3*px_c3^2*q1dotdot)/2 + m1*py_c1^2*q1dotdot + (m2*py_c2^2*q1dotdot)/2 + (m3*py_c3^2*q1dotdot)/2 + m2*pz_c2^2*q1dotdot + m3*pz_c3^2*q1dotdot + (I_xx_c3*q2dotdot*cos(q2 + 2*q3))/2 - (I_yy_c3*q2dotdot*cos(q2 + 2*q3))/2 - (a2*fy*cos(q2 - q4))/2 + (a2*fx*sin(q2 - q4))/2 - (a3*fy*cos(q2 + q3 + q4))/2 - (d3*fx*cos(q2 + q3 + q4))/2 - (d4*fx*cos(q2 + q3 + q4))/2 - (a3*fx*sin(q2 + q3 + q4))/2 - (I_xx_c2*q1dotdot*cos(2*q2))/2 + (I_yy_c2*q1dotdot*cos(2*q2))/2 + (d3*fy*sin(q2 + q3 + q4))/2 + (d4*fy*sin(q2 + q3 + q4))/2 - (I_xx_c3*q1dotdot*cos(2*q2 + 2*q3))/2 + (I_yy_c3*q1dotdot*cos(2*q2 + 2*q3))/2 - (a3*fy*cos(q2 + q3 - q4))/2 - (d3*fx*cos(q2 + q3 - q4))/2 + (d4*fx*cos(q2 + q3 - q4))/2 + (a3*fx*sin(q2 + q3 - q4))/2 - (d3*fy*sin(q2 + q3 - q4))/2 + (d4*fy*sin(q2 + q3 - q4))/2 - (a2*fy*cos(q2 + q4))/2 - (a2*fx*sin(q2 + q4))/2 + d3*fz*sin(q2 + q3) - (I_xx_c3*q2dotdot*cos(q2))/2 - I_yy_c2*q2dotdot*cos(q2) - (I_yy_c3*q2dotdot*cos(q2))/2 + (a2^2*m3*q1dotdot)/2 - (m3*px_c3^2*q2dotdot*cos(q2 + 2*q3))/2 + (m3*py_c3^2*q2dotdot*cos(q2 + 2*q3))/2 + 2*d3*m3*pz_c3*q1dotdot + (a2^2*m3*q1dotdot*cos(2*q2))/2 + (m2*px_c2^2*q1dotdot*cos(2*q2))/2 - (m2*py_c2^2*q1dotdot*cos(2*q2))/2 - I_zz_c3*q2dot*q3dot*sin(q2) + (m3*px_c3^2*q1dotdot*cos(2*q2 + 2*q3))/2 - (m3*py_c3^2*q1dotdot*cos(2*q2 + 2*q3))/2 - I_xx_c3*q2dot*q3dot*sin(q2 + 2*q3) + I_yy_c3*q2dot*q3dot*sin(q2 + 2*q3) + (I_xx_c2*q1dot*q2dot*sin(2*q2))/2 - (I_yy_c2*q1dot*q2dot*sin(2*q2))/2 - a2^2*m3*q2dotdot*cos(q2) - d3^2*m3*q2dotdot*cos(q2) - m2*px_c2^2*q2dotdot*cos(q2) - (m3*px_c3^2*q2dotdot*cos(q2))/2 - (m3*py_c3^2*q2dotdot*cos(q2))/2 - m2*pz_c2^2*q2dotdot*cos(q2) - m3*pz_c3^2*q2dotdot*cos(q2) + (I_xx_c3*q1dot*q2dot*sin(2*q2 + 2*q3))/2 + I_xx_c3*q1dot*q3dot*sin(2*q2 + 2*q3) - (I_yy_c3*q1dot*q2dot*sin(2*q2 + 2*q3))/2 - I_yy_c3*q1dot*q3dot*sin(2*q2 + 2*q3) + m2*px_c2*py_c2*q2dotdot*sin(q2) + a2*m3*px_c3*q1dotdot*cos(2*q2 + q3) - (a2*m3*px_c3*q2dotdot*cos(q2 - q3))/2 - (d3*m3*px_c3*q2dot^2*cos(q2 + q3))/2 + d3*m3*px_c3*q3dot^2*cos(q2 + q3) - (m3*px_c3*pz_c3*q2dot^2*cos(q2 + q3))/2 + m3*px_c3*pz_c3*q3dot^2*cos(q2 + q3) - a2*m3*py_c3*q1dotdot*sin(2*q2 + q3) - (a2*m3*py_c3*q2dotdot*sin(q2 - q3))/2 + (d3*m3*py_c3*q2dot^2*sin(q2 + q3))/2 - d3*m3*py_c3*q3dot^2*sin(q2 + q3) + m3*px_c3*py_c3*q2dotdot*sin(q2 + 2*q3) + (m3*py_c3*pz_c3*q2dot^2*sin(q2 + q3))/2 - m3*py_c3*pz_c3*q3dot^2*sin(q2 + q3) - m2*px_c2*py_c2*q1dotdot*sin(2*q2) + m2*py_c2*pz_c2*q2dot^2*sin(q2) - m3*px_c3^2*q2dot*q3dot*sin(q2) - m3*py_c3^2*q2dot*q3dot*sin(q2) - (a2*d3*m3*q1dot*q2dot)/2 + (d3*m3*px_c3*q2dot^2*cos(q2 - q3))/2 - (a2*m3*pz_c3*q1dot*q2dot)/2 + (m3*px_c3*pz_c3*q2dot^2*cos(q2 - q3))/2 + (d3*m3*py_c3*q2dot^2*sin(q2 - q3))/2 - (m2*px_c2*pz_c2*q1dot*q2dot)/2 - m3*px_c3*py_c3*q1dotdot*sin(2*q2 + 2*q3) + (m3*py_c3*pz_c3*q2dot^2*sin(q2 - q3))/2 + m3*px_c3^2*q2dot*q3dot*sin(q2 + 2*q3) - m3*py_c3^2*q2dot*q3dot*sin(q2 + 2*q3) - (a2^2*m3*q1dot*q2dot*sin(2*q2))/2 - (3*a2*m3*px_c3*q2dotdot*cos(q2 + q3))/2 + d3*m3*py_c3*q3dotdot*cos(q2 + q3) - (m2*px_c2^2*q1dot*q2dot*sin(2*q2))/2 + (m2*py_c2^2*q1dot*q2dot*sin(2*q2))/2 + m3*py_c3*pz_c3*q3dotdot*cos(q2 + q3) + (3*a2*m3*py_c3*q2dotdot*sin(q2 + q3))/2 + d3*m3*px_c3*q3dotdot*sin(q2 + q3) + m3*px_c3*pz_c3*q3dotdot*sin(q2 + q3) + a2*m3*px_c3*q1dotdot*cos(q3) - 2*d3*m3*pz_c3*q2dotdot*cos(q2) - (m3*px_c3^2*q1dot*q2dot*sin(2*q2 + 2*q3))/2 - m3*px_c3^2*q1dot*q3dot*sin(2*q2 + 2*q3) + (m3*py_c3^2*q1dot*q2dot*sin(2*q2 + 2*q3))/2 + m3*py_c3^2*q1dot*q3dot*sin(2*q2 + 2*q3) - a2*m3*py_c3*q1dotdot*sin(q3) + a2*m3*py_c3*q2dot*q3dot*cos(q2 + q3) + a2*m3*px_c3*q2dot*q3dot*sin(q2 + q3) - a2*m3*py_c3*q1dot*q3dot*cos(q3) - (d3*m3*px_c3*q1dot*q2dot*cos(q3))/2 - (m3*px_c3*pz_c3*q1dot*q2dot*cos(q3))/2 - a2*m3*px_c3*q1dot*q3dot*sin(q3) + (d3*m3*py_c3*q1dot*q2dot*sin(q3))/2 + (m3*py_c3*pz_c3*q1dot*q2dot*sin(q3))/2 - a2*m3*py_c3*q1dot*q2dot*cos(2*q2 + q3) - a2*m3*py_c3*q1dot*q3dot*cos(2*q2 + q3) + a2*m3*py_c3*q2dot*q3dot*cos(q2 - q3) + (d3*m3*px_c3*q1dot*q2dot*cos(2*q2 + q3))/2 + 2*m3*px_c3*py_c3*q2dot*q3dot*cos(q2 + 2*q3) + (m3*px_c3*pz_c3*q1dot*q2dot*cos(2*q2 + q3))/2 - a2*m3*px_c3*q1dot*q2dot*sin(2*q2 + q3) - a2*m3*px_c3*q1dot*q3dot*sin(2*q2 + q3) - a2*m3*px_c3*q2dot*q3dot*sin(q2 - q3) - (d3*m3*py_c3*q1dot*q2dot*sin(2*q2 + q3))/2 - (m3*py_c3*pz_c3*q1dot*q2dot*sin(2*q2 + q3))/2 + (a2*d3*m3*q1dot*q2dot*cos(2*q2))/2 + (a2*m3*pz_c3*q1dot*q2dot*cos(2*q2))/2 - m2*px_c2*py_c2*q1dot*q2dot*cos(2*q2) + (m2*px_c2*pz_c2*q1dot*q2dot*cos(2*q2))/2 - (m2*py_c2*pz_c2*q1dot*q2dot*sin(2*q2))/2 - m3*px_c3*py_c3*q1dot*q2dot*cos(2*q2 + 2*q3) - 2*m3*px_c3*py_c3*q1dot*q3dot*cos(2*q2 + 2*q3); ...
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          (I_xx_c3*q2dotdot)/2 + I_yy_c2*q2dotdot + (I_yy_c3*q2dotdot)/2 + (ny*cos(q3 + q4))/2 + (nx*sin(q3 + q4))/2 + nz*cos(q3) - (ny*cos(q3 - q4))/2 + (nx*sin(q3 - q4))/2 + d3^2*m3*q2dotdot + a2*fx*sin(q4) + m2*px_c2^2*q2dotdot + (m3*px_c3^2*q2dotdot)/2 + (m3*py_c3^2*q2dotdot)/2 + m2*pz_c2^2*q2dotdot + m3*pz_c3^2*q2dotdot - d3*fz*sin(q3) + (I_xx_c3*q1dotdot*cos(q2 + 2*q3))/2 - (I_yy_c3*q1dotdot*cos(q2 + 2*q3))/2 + (a3*fy*cos(q3 - q4))/2 + (d3*fx*cos(q3 - q4))/2 - (d4*fx*cos(q3 - q4))/2 - (a3*fx*sin(q3 - q4))/2 + (d3*fy*sin(q3 - q4))/2 - (d4*fy*sin(q3 - q4))/2 - (I_xx_c3*q2dotdot*cos(2*q3))/2 + (I_yy_c3*q2dotdot*cos(2*q3))/2 + (a3*fy*cos(q3 + q4))/2 + (d3*fx*cos(q3 + q4))/2 + (d4*fx*cos(q3 + q4))/2 + (a3*fx*sin(q3 + q4))/2 - (d3*fy*sin(q3 + q4))/2 - (d4*fy*sin(q3 + q4))/2 - (I_xx_c3*q1dotdot*cos(q2))/2 - I_yy_c2*q1dotdot*cos(q2) - (I_yy_c3*q1dotdot*cos(q2))/2 + a2*fy*cos(q4) + a2^2*m3*q2dotdot - (m3*px_c3^2*q1dotdot*cos(q2 + 2*q3))/2 + (m3*py_c3^2*q1dotdot*cos(q2 + 2*q3))/2 + 2*d3*m3*pz_c3*q2dotdot + (m3*px_c3^2*q2dotdot*cos(2*q3))/2 - (m3*py_c3^2*q2dotdot*cos(2*q3))/2 + (a2*d3*m3*q1dot^2)/2 + (a2*m3*pz_c3*q1dot^2)/2 + (I_xx_c3*q1dot*q2dot*sin(q2))/2 + I_yy_c2*q1dot*q2dot*sin(q2) + (I_yy_c3*q1dot*q2dot*sin(q2))/2 + I_zz_c3*q1dot*q3dot*sin(q2) - d3*g*m3*sin(q2) + (m2*px_c2*pz_c2*q1dot^2)/2 - g*m2*pz_c2*sin(q2) - g*m3*pz_c3*sin(q2) - (I_xx_c3*q1dot*q2dot*sin(q2 + 2*q3))/2 - I_xx_c3*q1dot*q3dot*sin(q2 + 2*q3) + (I_yy_c3*q1dot*q2dot*sin(q2 + 2*q3))/2 + I_yy_c3*q1dot*q3dot*sin(q2 + 2*q3) + I_xx_c3*q2dot*q3dot*sin(2*q3) - I_yy_c3*q2dot*q3dot*sin(2*q3) - a2^2*m3*q1dotdot*cos(q2) - d3^2*m3*q1dotdot*cos(q2) - m2*px_c2^2*q1dotdot*cos(q2) - (m3*px_c3^2*q1dotdot*cos(q2))/2 - (m3*py_c3^2*q1dotdot*cos(q2))/2 - m2*pz_c2^2*q1dotdot*cos(q2) - m3*pz_c3^2*q1dotdot*cos(q2) + m2*px_c2*py_c2*q1dotdot*sin(q2) - m3*px_c3*pz_c3*q3dotdot*sin(q3) - (a2*m3*px_c3*q1dotdot*cos(q2 - q3))/2 - (a2*m3*py_c3*q1dotdot*sin(q2 - q3))/2 + m3*px_c3*py_c3*q1dotdot*sin(q2 + 2*q3) + (d3*m3*px_c3*q1dot^2*cos(q3))/2 - d3*m3*px_c3*q3dot^2*cos(q3) + (m3*px_c3*pz_c3*q1dot^2*cos(q3))/2 - m3*px_c3*pz_c3*q3dot^2*cos(q3) + a2^2*m3*q1dot*q2dot*sin(q2) - (d3*m3*py_c3*q1dot^2*sin(q3))/2 + d3*m3*py_c3*q3dot^2*sin(q3) + d3^2*m3*q1dot*q2dot*sin(q2) - m3*px_c3*py_c3*q2dotdot*sin(2*q3) - (m3*py_c3*pz_c3*q1dot^2*sin(q3))/2 + m3*py_c3*pz_c3*q3dot^2*sin(q3) + m2*px_c2^2*q1dot*q2dot*sin(q2) + (m3*px_c3^2*q1dot*q2dot*sin(q2))/2 + m3*px_c3^2*q1dot*q3dot*sin(q2) + (m3*py_c3^2*q1dot*q2dot*sin(q2))/2 + m3*py_c3^2*q1dot*q3dot*sin(q2) + m2*pz_c2^2*q1dot*q2dot*sin(q2) + m3*pz_c3^2*q1dot*q2dot*sin(q2) - (d3*m3*px_c3*q1dot^2*cos(2*q2 + q3))/2 - (m3*px_c3*pz_c3*q1dot^2*cos(2*q2 + q3))/2 + (d3*m3*py_c3*q1dot^2*sin(2*q2 + q3))/2 + (m3*py_c3*pz_c3*q1dot^2*sin(2*q2 + q3))/2 + (m3*px_c3^2*q1dot*q2dot*sin(q2 + 2*q3))/2 + m3*px_c3^2*q1dot*q3dot*sin(q2 + 2*q3) - (m3*py_c3^2*q1dot*q2dot*sin(q2 + 2*q3))/2 - m3*py_c3^2*q1dot*q3dot*sin(q2 + 2*q3) - (a2*d3*m3*q1dot^2*cos(2*q2))/2 - (a2*m3*pz_c3*q1dot^2*cos(2*q2))/2 - (m2*px_c2*pz_c2*q1dot^2*cos(2*q2))/2 - (3*a2*m3*px_c3*q1dotdot*cos(q2 + q3))/2 + (m2*py_c2*pz_c2*q1dot^2*sin(2*q2))/2 - m3*px_c3^2*q2dot*q3dot*sin(2*q3) + m3*py_c3^2*q2dot*q3dot*sin(2*q3) + (3*a2*m3*py_c3*q1dotdot*sin(q2 + q3))/2 + 2*a2*m3*px_c3*q2dotdot*cos(q3) - d3*m3*py_c3*q3dotdot*cos(q3) - 2*d3*m3*pz_c3*q1dotdot*cos(q2) - m3*py_c3*pz_c3*q3dotdot*cos(q3) - 2*a2*m3*py_c3*q2dotdot*sin(q3) - d3*m3*px_c3*q3dotdot*sin(q3) + (3*a2*m3*py_c3*q1dot*q2dot*cos(q2 + q3))/2 + 2*a2*m3*py_c3*q1dot*q3dot*cos(q2 + q3) + (d3*m3*px_c3*q1dot*q2dot*cos(q2 + q3))/2 + (m3*px_c3*pz_c3*q1dot*q2dot*cos(q2 + q3))/2 + (3*a2*m3*px_c3*q1dot*q2dot*sin(q2 + q3))/2 + 2*a2*m3*px_c3*q1dot*q3dot*sin(q2 + q3) - (d3*m3*py_c3*q1dot*q2dot*sin(q2 + q3))/2 - (m3*py_c3*pz_c3*q1dot*q2dot*sin(q2 + q3))/2 - 2*a2*m3*py_c3*q2dot*q3dot*cos(q3) + m2*px_c2*py_c2*q1dot*q2dot*cos(q2) - 2*a2*m3*px_c3*q2dot*q3dot*sin(q3) + 2*d3*m3*pz_c3*q1dot*q2dot*sin(q2) - m2*py_c2*pz_c2*q1dot*q2dot*sin(q2) - (a2*m3*py_c3*q1dot*q2dot*cos(q2 - q3))/2 - (d3*m3*px_c3*q1dot*q2dot*cos(q2 - q3))/2 + m3*px_c3*py_c3*q1dot*q2dot*cos(q2 + 2*q3) + 2*m3*px_c3*py_c3*q1dot*q3dot*cos(q2 + 2*q3) - (m3*px_c3*pz_c3*q1dot*q2dot*cos(q2 - q3))/2 + (a2*m3*px_c3*q1dot*q2dot*sin(q2 - q3))/2 - (d3*m3*py_c3*q1dot*q2dot*sin(q2 - q3))/2 - (m3*py_c3*pz_c3*q1dot*q2dot*sin(q2 - q3))/2 - 2*m3*px_c3*py_c3*q2dot*q3dot*cos(2*q3); ...
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          I_zz_c3*q3dotdot + a3*fz - ny*cos(q4) - nx*sin(q4) + m3*px_c3^2*q3dotdot + m3*py_c3^2*q3dotdot + d4*fy*sin(q4) - (I_xx_c3*q2dot^2*sin(2*q3))/2 + (I_yy_c3*q2dot^2*sin(2*q3))/2 - (I_xx_c3*q1dot^2*sin(2*q2 + 2*q3))/2 + (I_yy_c3*q1dot^2*sin(2*q2 + 2*q3))/2 - d4*fx*cos(q4) - g*m3*px_c3*cos(q2 + q3) + g*m3*py_c3*sin(q2 + q3) + I_xx_c3*q1dot*q2dot*sin(q2 + 2*q3) - I_yy_c3*q1dot*q2dot*sin(q2 + 2*q3) + (m3*px_c3^2*q2dot^2*sin(2*q3))/2 - (m3*py_c3^2*q2dot^2*sin(2*q3))/2 + (m3*px_c3^2*q1dot^2*sin(2*q2 + 2*q3))/2 - (m3*py_c3^2*q1dot^2*sin(2*q2 + 2*q3))/2 - m3*px_c3*pz_c3*q2dotdot*sin(q3) + (a2*m3*py_c3*q1dot^2*cos(q3))/2 + a2*m3*py_c3*q2dot^2*cos(q3) + (a2*m3*px_c3*q1dot^2*sin(q3))/2 + a2*m3*px_c3*q2dot^2*sin(q3) + (a2*m3*py_c3*q1dot^2*cos(2*q2 + q3))/2 + (a2*m3*px_c3*q1dot^2*sin(2*q2 + q3))/2 - m3*px_c3^2*q1dot*q2dot*sin(q2 + 2*q3) + m3*py_c3^2*q1dot*q2dot*sin(q2 + 2*q3) + m3*px_c3*py_c3*q2dot^2*cos(2*q3) + d3*m3*py_c3*q1dotdot*cos(q2 + q3) + m3*py_c3*pz_c3*q1dotdot*cos(q2 + q3) + d3*m3*px_c3*q1dotdot*sin(q2 + q3) + m3*px_c3*pz_c3*q1dotdot*sin(q2 + q3) + m3*px_c3*py_c3*q1dot^2*cos(2*q2 + 2*q3) - d3*m3*py_c3*q2dotdot*cos(q3) - m3*py_c3*pz_c3*q2dotdot*cos(q3) - d3*m3*px_c3*q2dotdot*sin(q3) - (3*a2*m3*py_c3*q1dot*q2dot*cos(q2 + q3))/2 + d3*m3*px_c3*q1dot*q2dot*cos(q2 + q3) + m3*px_c3*pz_c3*q1dot*q2dot*cos(q2 + q3) - (3*a2*m3*px_c3*q1dot*q2dot*sin(q2 + q3))/2 - d3*m3*py_c3*q1dot*q2dot*sin(q2 + q3) - m3*py_c3*pz_c3*q1dot*q2dot*sin(q2 + q3) - (a2*m3*py_c3*q1dot*q2dot*cos(q2 - q3))/2 - 2*m3*px_c3*py_c3*q1dot*q2dot*cos(q2 + 2*q3) + (a2*m3*px_c3*q1dot*q2dot*sin(q2 - q3))/2]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
TAU_B = [(I_xx_c2*q1dotdot)/2 + (I_xx_c3*q1dotdot)/2 + (I_yy_c2*q1dotdot)/2 + (I_yy_c3*q1dotdot)/2 + I_zz_c1*q1dotdot - ft5*cos(q2 + q3) - ft4*sin(q2 + q3) + d3^2*m3*q1dotdot + m1*px_c1^2*q1dotdot + (m2*px_c2^2*q1dotdot)/2 + (m3*px_c3^2*q1dotdot)/2 + m1*py_c1^2*q1dotdot + (m2*py_c2^2*q1dotdot)/2 + (m3*py_c3^2*q1dotdot)/2 + m2*pz_c2^2*q1dotdot + m3*pz_c3^2*q1dotdot + (I_xx_c3*q2dotdot*cos(q2 + 2*q3))/2 - (I_yy_c3*q2dotdot*cos(q2 + 2*q3))/2 - (I_xx_c2*q1dotdot*cos(2*q2))/2 + (I_yy_c2*q1dotdot*cos(2*q2))/2 - (I_xx_c3*q1dotdot*cos(2*q2 + 2*q3))/2 + (I_yy_c3*q1dotdot*cos(2*q2 + 2*q3))/2 + Px_6_tool*ft3*cos(q2 + q3) - Pz_6_tool*ft1*cos(q2 + q3) + Pz_6_tool*ft2*sin(q2 + q3) - d3*ft1*cos(q2 + q3) + d3*ft2*sin(q2 + q3) - (I_xx_c3*q2dotdot*cos(q2))/2 - I_yy_c2*q2dotdot*cos(q2) - (I_yy_c3*q2dotdot*cos(q2))/2 + a2*ft3*cos(q2) + (a2^2*m3*q1dotdot)/2 - (m3*px_c3^2*q2dotdot*cos(q2 + 2*q3))/2 + (m3*py_c3^2*q2dotdot*cos(q2 + 2*q3))/2 + 2*d3*m3*pz_c3*q1dotdot + (a2^2*m3*q1dotdot*cos(2*q2))/2 + (m2*px_c2^2*q1dotdot*cos(2*q2))/2 - (m2*py_c2^2*q1dotdot*cos(2*q2))/2 - I_zz_c3*q2dot*q3dot*sin(q2) + (m3*px_c3^2*q1dotdot*cos(2*q2 + 2*q3))/2 - (m3*py_c3^2*q1dotdot*cos(2*q2 + 2*q3))/2 - I_xx_c3*q2dot*q3dot*sin(q2 + 2*q3) + I_yy_c3*q2dot*q3dot*sin(q2 + 2*q3) + (I_xx_c2*q1dot*q2dot*sin(2*q2))/2 - (I_yy_c2*q1dot*q2dot*sin(2*q2))/2 - a2^2*m3*q2dotdot*cos(q2) - d3^2*m3*q2dotdot*cos(q2) - m2*px_c2^2*q2dotdot*cos(q2) - (m3*px_c3^2*q2dotdot*cos(q2))/2 - (m3*py_c3^2*q2dotdot*cos(q2))/2 - m2*pz_c2^2*q2dotdot*cos(q2) - m3*pz_c3^2*q2dotdot*cos(q2) + (I_xx_c3*q1dot*q2dot*sin(2*q2 + 2*q3))/2 + I_xx_c3*q1dot*q3dot*sin(2*q2 + 2*q3) - (I_yy_c3*q1dot*q2dot*sin(2*q2 + 2*q3))/2 - I_yy_c3*q1dot*q3dot*sin(2*q2 + 2*q3) + m2*px_c2*py_c2*q2dotdot*sin(q2) + a2*m3*px_c3*q1dotdot*cos(2*q2 + q3) - (a2*m3*px_c3*q2dotdot*cos(q2 - q3))/2 - (d3*m3*px_c3*q2dot^2*cos(q2 + q3))/2 + d3*m3*px_c3*q3dot^2*cos(q2 + q3) - (m3*px_c3*pz_c3*q2dot^2*cos(q2 + q3))/2 + m3*px_c3*pz_c3*q3dot^2*cos(q2 + q3) - a2*m3*py_c3*q1dotdot*sin(2*q2 + q3) - (a2*m3*py_c3*q2dotdot*sin(q2 - q3))/2 + (d3*m3*py_c3*q2dot^2*sin(q2 + q3))/2 - d3*m3*py_c3*q3dot^2*sin(q2 + q3) + m3*px_c3*py_c3*q2dotdot*sin(q2 + 2*q3) + (m3*py_c3*pz_c3*q2dot^2*sin(q2 + q3))/2 - m3*py_c3*pz_c3*q3dot^2*sin(q2 + q3) - m2*px_c2*py_c2*q1dotdot*sin(2*q2) + m2*py_c2*pz_c2*q2dot^2*sin(q2) - m3*px_c3^2*q2dot*q3dot*sin(q2) - m3*py_c3^2*q2dot*q3dot*sin(q2) - (a2*d3*m3*q1dot*q2dot)/2 + (d3*m3*px_c3*q2dot^2*cos(q2 - q3))/2 - (a2*m3*pz_c3*q1dot*q2dot)/2 + (m3*px_c3*pz_c3*q2dot^2*cos(q2 - q3))/2 + (d3*m3*py_c3*q2dot^2*sin(q2 - q3))/2 - (m2*px_c2*pz_c2*q1dot*q2dot)/2 - m3*px_c3*py_c3*q1dotdot*sin(2*q2 + 2*q3) + (m3*py_c3*pz_c3*q2dot^2*sin(q2 - q3))/2 + m3*px_c3^2*q2dot*q3dot*sin(q2 + 2*q3) - m3*py_c3^2*q2dot*q3dot*sin(q2 + 2*q3) - (a2^2*m3*q1dot*q2dot*sin(2*q2))/2 - (3*a2*m3*px_c3*q2dotdot*cos(q2 + q3))/2 + d3*m3*py_c3*q3dotdot*cos(q2 + q3) - (m2*px_c2^2*q1dot*q2dot*sin(2*q2))/2 + (m2*py_c2^2*q1dot*q2dot*sin(2*q2))/2 + m3*py_c3*pz_c3*q3dotdot*cos(q2 + q3) + (3*a2*m3*py_c3*q2dotdot*sin(q2 + q3))/2 + d3*m3*px_c3*q3dotdot*sin(q2 + q3) + m3*px_c3*pz_c3*q3dotdot*sin(q2 + q3) + a2*m3*px_c3*q1dotdot*cos(q3) - 2*d3*m3*pz_c3*q2dotdot*cos(q2) - (m3*px_c3^2*q1dot*q2dot*sin(2*q2 + 2*q3))/2 - m3*px_c3^2*q1dot*q3dot*sin(2*q2 + 2*q3) + (m3*py_c3^2*q1dot*q2dot*sin(2*q2 + 2*q3))/2 + m3*py_c3^2*q1dot*q3dot*sin(2*q2 + 2*q3) - a2*m3*py_c3*q1dotdot*sin(q3) + a2*m3*py_c3*q2dot*q3dot*cos(q2 + q3) + a2*m3*px_c3*q2dot*q3dot*sin(q2 + q3) - a2*m3*py_c3*q1dot*q3dot*cos(q3) - (d3*m3*px_c3*q1dot*q2dot*cos(q3))/2 - (m3*px_c3*pz_c3*q1dot*q2dot*cos(q3))/2 - a2*m3*px_c3*q1dot*q3dot*sin(q3) + (d3*m3*py_c3*q1dot*q2dot*sin(q3))/2 + (m3*py_c3*pz_c3*q1dot*q2dot*sin(q3))/2 - a2*m3*py_c3*q1dot*q2dot*cos(2*q2 + q3) - a2*m3*py_c3*q1dot*q3dot*cos(2*q2 + q3) + a2*m3*py_c3*q2dot*q3dot*cos(q2 - q3) + (d3*m3*px_c3*q1dot*q2dot*cos(2*q2 + q3))/2 + 2*m3*px_c3*py_c3*q2dot*q3dot*cos(q2 + 2*q3) + (m3*px_c3*pz_c3*q1dot*q2dot*cos(2*q2 + q3))/2 - a2*m3*px_c3*q1dot*q2dot*sin(2*q2 + q3) - a2*m3*px_c3*q1dot*q3dot*sin(2*q2 + q3) - a2*m3*px_c3*q2dot*q3dot*sin(q2 - q3) - (d3*m3*py_c3*q1dot*q2dot*sin(2*q2 + q3))/2 - (m3*py_c3*pz_c3*q1dot*q2dot*sin(2*q2 + q3))/2 + (a2*d3*m3*q1dot*q2dot*cos(2*q2))/2 + (a2*m3*pz_c3*q1dot*q2dot*cos(2*q2))/2 - m2*px_c2*py_c2*q1dot*q2dot*cos(2*q2) + (m2*px_c2*pz_c2*q1dot*q2dot*cos(2*q2))/2 - (m2*py_c2*pz_c2*q1dot*q2dot*sin(2*q2))/2 - m3*px_c3*py_c3*q1dot*q2dot*cos(2*q2 + 2*q3) - 2*m3*px_c3*py_c3*q1dot*q3dot*cos(2*q2 + 2*q3);...
                                                                                                                                                                                                                                                                                                                                                                                                                          (I_xx_c3*q2dotdot)/2 + I_yy_c2*q2dotdot + (I_yy_c3*q2dotdot)/2 - a2*ft3 + ft5*cos(q3) + ft4*sin(q3) + d3^2*m3*q2dotdot + m2*px_c2^2*q2dotdot + (m3*px_c3^2*q2dotdot)/2 + (m3*py_c3^2*q2dotdot)/2 + m2*pz_c2^2*q2dotdot + m3*pz_c3^2*q2dotdot - d3*ft2*sin(q3) + (I_xx_c3*q1dotdot*cos(q2 + 2*q3))/2 - (I_yy_c3*q1dotdot*cos(q2 + 2*q3))/2 - (I_xx_c3*q2dotdot*cos(2*q3))/2 + (I_yy_c3*q2dotdot*cos(2*q3))/2 - Px_6_tool*ft3*cos(q3) + Pz_6_tool*ft1*cos(q3) - (I_xx_c3*q1dotdot*cos(q2))/2 - I_yy_c2*q1dotdot*cos(q2) - (I_yy_c3*q1dotdot*cos(q2))/2 - Pz_6_tool*ft2*sin(q3) + a2^2*m3*q2dotdot + d3*ft1*cos(q3) - (m3*px_c3^2*q1dotdot*cos(q2 + 2*q3))/2 + (m3*py_c3^2*q1dotdot*cos(q2 + 2*q3))/2 + 2*d3*m3*pz_c3*q2dotdot + (m3*px_c3^2*q2dotdot*cos(2*q3))/2 - (m3*py_c3^2*q2dotdot*cos(2*q3))/2 + (a2*d3*m3*q1dot^2)/2 + (a2*m3*pz_c3*q1dot^2)/2 + (I_xx_c3*q1dot*q2dot*sin(q2))/2 + I_yy_c2*q1dot*q2dot*sin(q2) + (I_yy_c3*q1dot*q2dot*sin(q2))/2 + I_zz_c3*q1dot*q3dot*sin(q2) - d3*g*m3*sin(q2) + (m2*px_c2*pz_c2*q1dot^2)/2 - g*m2*pz_c2*sin(q2) - g*m3*pz_c3*sin(q2) - (I_xx_c3*q1dot*q2dot*sin(q2 + 2*q3))/2 - I_xx_c3*q1dot*q3dot*sin(q2 + 2*q3) + (I_yy_c3*q1dot*q2dot*sin(q2 + 2*q3))/2 + I_yy_c3*q1dot*q3dot*sin(q2 + 2*q3) + I_xx_c3*q2dot*q3dot*sin(2*q3) - I_yy_c3*q2dot*q3dot*sin(2*q3) - a2^2*m3*q1dotdot*cos(q2) - d3^2*m3*q1dotdot*cos(q2) - m2*px_c2^2*q1dotdot*cos(q2) - (m3*px_c3^2*q1dotdot*cos(q2))/2 - (m3*py_c3^2*q1dotdot*cos(q2))/2 - m2*pz_c2^2*q1dotdot*cos(q2) - m3*pz_c3^2*q1dotdot*cos(q2) + m2*px_c2*py_c2*q1dotdot*sin(q2) - m3*px_c3*pz_c3*q3dotdot*sin(q3) - (a2*m3*px_c3*q1dotdot*cos(q2 - q3))/2 - (a2*m3*py_c3*q1dotdot*sin(q2 - q3))/2 + m3*px_c3*py_c3*q1dotdot*sin(q2 + 2*q3) + (d3*m3*px_c3*q1dot^2*cos(q3))/2 - d3*m3*px_c3*q3dot^2*cos(q3) + (m3*px_c3*pz_c3*q1dot^2*cos(q3))/2 - m3*px_c3*pz_c3*q3dot^2*cos(q3) + a2^2*m3*q1dot*q2dot*sin(q2) - (d3*m3*py_c3*q1dot^2*sin(q3))/2 + d3*m3*py_c3*q3dot^2*sin(q3) + d3^2*m3*q1dot*q2dot*sin(q2) - m3*px_c3*py_c3*q2dotdot*sin(2*q3) - (m3*py_c3*pz_c3*q1dot^2*sin(q3))/2 + m3*py_c3*pz_c3*q3dot^2*sin(q3) + m2*px_c2^2*q1dot*q2dot*sin(q2) + (m3*px_c3^2*q1dot*q2dot*sin(q2))/2 + m3*px_c3^2*q1dot*q3dot*sin(q2) + (m3*py_c3^2*q1dot*q2dot*sin(q2))/2 + m3*py_c3^2*q1dot*q3dot*sin(q2) + m2*pz_c2^2*q1dot*q2dot*sin(q2) + m3*pz_c3^2*q1dot*q2dot*sin(q2) - (d3*m3*px_c3*q1dot^2*cos(2*q2 + q3))/2 - (m3*px_c3*pz_c3*q1dot^2*cos(2*q2 + q3))/2 + (d3*m3*py_c3*q1dot^2*sin(2*q2 + q3))/2 + (m3*py_c3*pz_c3*q1dot^2*sin(2*q2 + q3))/2 + (m3*px_c3^2*q1dot*q2dot*sin(q2 + 2*q3))/2 + m3*px_c3^2*q1dot*q3dot*sin(q2 + 2*q3) - (m3*py_c3^2*q1dot*q2dot*sin(q2 + 2*q3))/2 - m3*py_c3^2*q1dot*q3dot*sin(q2 + 2*q3) - (a2*d3*m3*q1dot^2*cos(2*q2))/2 - (a2*m3*pz_c3*q1dot^2*cos(2*q2))/2 - (m2*px_c2*pz_c2*q1dot^2*cos(2*q2))/2 - (3*a2*m3*px_c3*q1dotdot*cos(q2 + q3))/2 + (m2*py_c2*pz_c2*q1dot^2*sin(2*q2))/2 - m3*px_c3^2*q2dot*q3dot*sin(2*q3) + m3*py_c3^2*q2dot*q3dot*sin(2*q3) + (3*a2*m3*py_c3*q1dotdot*sin(q2 + q3))/2 + 2*a2*m3*px_c3*q2dotdot*cos(q3) - d3*m3*py_c3*q3dotdot*cos(q3) - 2*d3*m3*pz_c3*q1dotdot*cos(q2) - m3*py_c3*pz_c3*q3dotdot*cos(q3) - 2*a2*m3*py_c3*q2dotdot*sin(q3) - d3*m3*px_c3*q3dotdot*sin(q3) + (3*a2*m3*py_c3*q1dot*q2dot*cos(q2 + q3))/2 + 2*a2*m3*py_c3*q1dot*q3dot*cos(q2 + q3) + (d3*m3*px_c3*q1dot*q2dot*cos(q2 + q3))/2 + (m3*px_c3*pz_c3*q1dot*q2dot*cos(q2 + q3))/2 + (3*a2*m3*px_c3*q1dot*q2dot*sin(q2 + q3))/2 + 2*a2*m3*px_c3*q1dot*q3dot*sin(q2 + q3) - (d3*m3*py_c3*q1dot*q2dot*sin(q2 + q3))/2 - (m3*py_c3*pz_c3*q1dot*q2dot*sin(q2 + q3))/2 - 2*a2*m3*py_c3*q2dot*q3dot*cos(q3) + m2*px_c2*py_c2*q1dot*q2dot*cos(q2) - 2*a2*m3*px_c3*q2dot*q3dot*sin(q3) + 2*d3*m3*pz_c3*q1dot*q2dot*sin(q2) - m2*py_c2*pz_c2*q1dot*q2dot*sin(q2) - (a2*m3*py_c3*q1dot*q2dot*cos(q2 - q3))/2 - (d3*m3*px_c3*q1dot*q2dot*cos(q2 - q3))/2 + m3*px_c3*py_c3*q1dot*q2dot*cos(q2 + 2*q3) + 2*m3*px_c3*py_c3*q1dot*q3dot*cos(q2 + 2*q3) - (m3*px_c3*pz_c3*q1dot*q2dot*cos(q2 - q3))/2 + (a2*m3*px_c3*q1dot*q2dot*sin(q2 - q3))/2 - (d3*m3*py_c3*q1dot*q2dot*sin(q2 - q3))/2 - (m3*py_c3*pz_c3*q1dot*q2dot*sin(q2 - q3))/2 - 2*m3*px_c3*py_c3*q2dot*q3dot*cos(2*q3);...
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ft6 + Px_6_tool*ft2 + I_zz_c3*q3dotdot + m3*px_c3^2*q3dotdot + m3*py_c3^2*q3dotdot - (I_xx_c3*q2dot^2*sin(2*q3))/2 + (I_yy_c3*q2dot^2*sin(2*q3))/2 - (I_xx_c3*q1dot^2*sin(2*q2 + 2*q3))/2 + (I_yy_c3*q1dot^2*sin(2*q2 + 2*q3))/2 - g*m3*px_c3*cos(q2 + q3) + g*m3*py_c3*sin(q2 + q3) + I_xx_c3*q1dot*q2dot*sin(q2 + 2*q3) - I_yy_c3*q1dot*q2dot*sin(q2 + 2*q3) + (m3*px_c3^2*q2dot^2*sin(2*q3))/2 - (m3*py_c3^2*q2dot^2*sin(2*q3))/2 + (m3*px_c3^2*q1dot^2*sin(2*q2 + 2*q3))/2 - (m3*py_c3^2*q1dot^2*sin(2*q2 + 2*q3))/2 - m3*px_c3*pz_c3*q2dotdot*sin(q3) + (a2*m3*py_c3*q1dot^2*cos(q3))/2 + a2*m3*py_c3*q2dot^2*cos(q3) + (a2*m3*px_c3*q1dot^2*sin(q3))/2 + a2*m3*px_c3*q2dot^2*sin(q3) + (a2*m3*py_c3*q1dot^2*cos(2*q2 + q3))/2 + (a2*m3*px_c3*q1dot^2*sin(2*q2 + q3))/2 - m3*px_c3^2*q1dot*q2dot*sin(q2 + 2*q3) + m3*py_c3^2*q1dot*q2dot*sin(q2 + 2*q3) + m3*px_c3*py_c3*q2dot^2*cos(2*q3) + d3*m3*py_c3*q1dotdot*cos(q2 + q3) + m3*py_c3*pz_c3*q1dotdot*cos(q2 + q3) + d3*m3*px_c3*q1dotdot*sin(q2 + q3) + m3*px_c3*pz_c3*q1dotdot*sin(q2 + q3) + m3*px_c3*py_c3*q1dot^2*cos(2*q2 + 2*q3) - d3*m3*py_c3*q2dotdot*cos(q3) - m3*py_c3*pz_c3*q2dotdot*cos(q3) - d3*m3*px_c3*q2dotdot*sin(q3) - (3*a2*m3*py_c3*q1dot*q2dot*cos(q2 + q3))/2 + d3*m3*px_c3*q1dot*q2dot*cos(q2 + q3) + m3*px_c3*pz_c3*q1dot*q2dot*cos(q2 + q3) - (3*a2*m3*px_c3*q1dot*q2dot*sin(q2 + q3))/2 - d3*m3*py_c3*q1dot*q2dot*sin(q2 + q3) - m3*py_c3*pz_c3*q1dot*q2dot*sin(q2 + q3) - (a2*m3*py_c3*q1dot*q2dot*cos(q2 - q3))/2 - 2*m3*px_c3*py_c3*q1dot*q2dot*cos(q2 + 2*q3) + (a2*m3*px_c3*q1dot*q2dot*sin(q2 - q3))/2]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           